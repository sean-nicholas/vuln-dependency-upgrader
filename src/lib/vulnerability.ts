// Safe versions for React (19.x vulnerable for CVE-2025-55184/55183 - fix is via Next.js upgrade)
// Note: React 19.0.0 through 19.2.1 are all affected by the new CVEs
// The fix comes from upgrading Next.js which includes patched react-server-dom-* packages
const SAFE_REACT_VERSIONS: string[] = [];

// Safe versions for Next.js (13.3+, 14.x, 15.x, 16.x vulnerable unless these specific versions)
// Updated for CVE-2025-55184 (DoS) and CVE-2025-55183 (Source Code Exposure) + CVE-2025-67779
const SAFE_NEXT_VERSIONS = [
  "14.2.35",
  "15.0.7",
  "15.1.11",
  "15.2.8",
  "15.3.8",
  "15.4.10",
  "15.5.9",
  "16.0.10",
];

// Safe versions for @types/react (19.x vulnerable unless these specific versions)
const SAFE_TYPES_REACT_VERSIONS = ["19.0.8", "19.1.6"];

// Safe versions for @types/react-dom (19.x vulnerable unless these specific versions)
const SAFE_TYPES_REACT_DOM_VERSIONS = ["19.0.4", "19.1.5"];

// Map of vulnerable minor versions to their safe patch version
// Note: React fix comes via Next.js upgrade - no standalone React patch available yet
export const REACT_UPGRADE_MAP: Record<string, string> = {};

export const NEXT_UPGRADE_MAP: Record<string, string> = {
  "14.2": "14.2.35",
  "15.0": "15.0.7",
  "15.1": "15.1.11",
  "15.2": "15.2.8",
  "15.3": "15.3.8",
  "15.4": "15.4.10",
  "15.5": "15.5.9",
  "16.0": "16.0.10",
};

export const TYPES_REACT_UPGRADE_MAP: Record<string, string> = {
  "19.0": "19.0.8",
  "19.1": "19.1.6",
};

export const TYPES_REACT_DOM_UPGRADE_MAP: Record<string, string> = {
  "19.0": "19.0.4",
  "19.1": "19.1.5",
};

function parseVersion(
  version: string
): { major: number; minor: number; patch: number } | null {
  // Remove leading ^ or ~ or =
  const cleaned = version.replace(/^[\^~=]/, "");
  const match = cleaned.match(/^(\d+)\.(\d+)\.(\d+)/);
  if (!match) return null;
  return {
    major: parseInt(match[1], 10),
    minor: parseInt(match[2], 10),
    patch: parseInt(match[3], 10),
  };
}

export function isReactVulnerable(version: string | null): boolean {
  if (!version) return false;

  const parsed = parseVersion(version);
  if (!parsed) return false;

  // React < 19 is not vulnerable
  if (parsed.major < 19) return false;

  // React 19.x is vulnerable unless it's one of the safe versions
  const cleanVersion = version.replace(/^[\^~=]/, "");
  const exactMatch = SAFE_REACT_VERSIONS.some((safe) =>
    cleanVersion.startsWith(safe)
  );

  if (exactMatch) return false;

  // If major is 19, it's vulnerable unless it's a safe version
  return parsed.major === 19;
}

export function isNextVulnerable(version: string | null): boolean {
  if (!version) return false;

  const parsed = parseVersion(version);
  if (!parsed) return false;

  // Next.js < 13 is not vulnerable
  if (parsed.major < 13) return false;

  // Next.js 13.x is only vulnerable from 13.3+
  if (parsed.major === 13 && parsed.minor < 3) return false;

  // Next.js 13.3+, 14.x, 15.x, and 16.x are vulnerable unless it's one of the safe versions
  const cleanVersion = version.replace(/^[\^~=]/, "");
  const exactMatch = SAFE_NEXT_VERSIONS.some((safe) =>
    cleanVersion.startsWith(safe)
  );

  if (exactMatch) return false;

  // If major is 13 (>=13.3), 14, 15, or 16, it's vulnerable unless it's a safe version
  return parsed.major >= 13 && parsed.major <= 16;
}

export function getSafeReactVersion(version: string): string | null {
  const parsed = parseVersion(version);
  if (!parsed) return null;

  const minorKey = `${parsed.major}.${parsed.minor}`;
  return REACT_UPGRADE_MAP[minorKey] || null;
}

export function getSafeNextVersion(version: string): string | null {
  const parsed = parseVersion(version);
  if (!parsed) return null;

  // Next.js 13.x should upgrade to 14.2.35
  if (parsed.major === 13) {
    return "14.2.35";
  }

  // Next.js 14.x (before 14.2) should upgrade to 14.2.35
  if (parsed.major === 14 && parsed.minor < 2) {
    return "14.2.35";
  }

  const minorKey = `${parsed.major}.${parsed.minor}`;
  return NEXT_UPGRADE_MAP[minorKey] || null;
}

export function isTypesReactVulnerable(version: string | null): boolean {
  if (!version) return false;

  const parsed = parseVersion(version);
  if (!parsed) return false;

  // @types/react < 19 is not vulnerable
  if (parsed.major < 19) return false;

  // @types/react 19.x is vulnerable unless it's one of the safe versions
  const cleanVersion = version.replace(/^[\^~=]/, "");
  const exactMatch = SAFE_TYPES_REACT_VERSIONS.some((safe) =>
    cleanVersion.startsWith(safe)
  );

  if (exactMatch) return false;

  // If major is 19, it's vulnerable unless it's a safe version
  return parsed.major === 19;
}

export function isTypesReactDomVulnerable(version: string | null): boolean {
  if (!version) return false;

  const parsed = parseVersion(version);
  if (!parsed) return false;

  // @types/react-dom < 19 is not vulnerable
  if (parsed.major < 19) return false;

  // @types/react-dom 19.x is vulnerable unless it's one of the safe versions
  const cleanVersion = version.replace(/^[\^~=]/, "");
  const exactMatch = SAFE_TYPES_REACT_DOM_VERSIONS.some((safe) =>
    cleanVersion.startsWith(safe)
  );

  if (exactMatch) return false;

  // If major is 19, it's vulnerable unless it's a safe version
  return parsed.major === 19;
}

export function getSafeTypesReactVersion(version: string): string | null {
  const parsed = parseVersion(version);
  if (!parsed) return null;

  const minorKey = `${parsed.major}.${parsed.minor}`;
  return TYPES_REACT_UPGRADE_MAP[minorKey] || null;
}

export function getSafeTypesReactDomVersion(version: string): string | null {
  const parsed = parseVersion(version);
  if (!parsed) return null;

  const minorKey = `${parsed.major}.${parsed.minor}`;
  return TYPES_REACT_DOM_UPGRADE_MAP[minorKey] || null;
}
