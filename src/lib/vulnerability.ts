// Safe versions for React (19.x vulnerable unless these specific versions)
const SAFE_REACT_VERSIONS = ["19.0.1", "19.1.2", "19.2.1"];

// Safe versions for Next.js (15.x and 16.x vulnerable unless these specific versions)
const SAFE_NEXT_VERSIONS = [
  "15.0.5",
  "15.1.9",
  "15.2.6",
  "15.3.6",
  "15.4.8",
  "15.5.7",
  "16.0.7",
];

// Map of vulnerable minor versions to their safe patch version
export const REACT_UPGRADE_MAP: Record<string, string> = {
  "19.0": "19.0.1",
  "19.1": "19.1.2",
  "19.2": "19.2.1",
};

export const NEXT_UPGRADE_MAP: Record<string, string> = {
  "15.0": "15.0.5",
  "15.1": "15.1.9",
  "15.2": "15.2.6",
  "15.3": "15.3.6",
  "15.4": "15.4.8",
  "15.5": "15.5.7",
  "16.0": "16.0.7",
};

function parseVersion(version: string): { major: number; minor: number; patch: number } | null {
  // Remove leading ^ or ~ or =
  const cleaned = version.replace(/^[\^~=]/, "");
  const match = cleaned.match(/^(\d+)\.(\d+)\.(\d+)/);
  if (!match) return null;
  return {
    major: parseInt(match[1], 10),
    minor: parseInt(match[2], 10),
    patch: parseInt(match[3], 10),
  };
}

export function isReactVulnerable(version: string | null): boolean {
  if (!version) return false;
  
  const parsed = parseVersion(version);
  if (!parsed) return false;
  
  // React < 19 is not vulnerable
  if (parsed.major < 19) return false;
  
  // React 19.x is vulnerable unless it's one of the safe versions
  const cleanVersion = version.replace(/^[\^~=]/, "");
  const exactMatch = SAFE_REACT_VERSIONS.some((safe) => cleanVersion.startsWith(safe));
  
  if (exactMatch) return false;
  
  // If major is 19, it's vulnerable unless it's a safe version
  return parsed.major === 19;
}

export function isNextVulnerable(version: string | null): boolean {
  if (!version) return false;
  
  const parsed = parseVersion(version);
  if (!parsed) return false;
  
  // Next.js < 15 is not vulnerable
  if (parsed.major < 15) return false;
  
  // Next.js 15.x and 16.x are vulnerable unless it's one of the safe versions
  const cleanVersion = version.replace(/^[\^~=]/, "");
  const exactMatch = SAFE_NEXT_VERSIONS.some((safe) => cleanVersion.startsWith(safe));
  
  if (exactMatch) return false;
  
  // If major is 15 or 16, it's vulnerable unless it's a safe version
  return parsed.major === 15 || parsed.major === 16;
}

export function getSafeReactVersion(version: string): string | null {
  const parsed = parseVersion(version);
  if (!parsed) return null;
  
  const minorKey = `${parsed.major}.${parsed.minor}`;
  return REACT_UPGRADE_MAP[minorKey] || null;
}

export function getSafeNextVersion(version: string): string | null {
  const parsed = parseVersion(version);
  if (!parsed) return null;
  
  const minorKey = `${parsed.major}.${parsed.minor}`;
  return NEXT_UPGRADE_MAP[minorKey] || null;
}

